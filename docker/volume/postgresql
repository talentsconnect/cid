# -*- mode: shell-script -*-

# Image: cid/postgresql
# Volume: postgresql-etc:/etc/postgresql
# Volume: postgresql-lib:/var/lib/postgresql

configdir='/etc/postgresql/9.6/main'
databasedir='/var/lib/postgresql/9.6/main'

install -d -o postgres -g postgres -m 700 "${databasedir}"

cat >> "${configdir}/pg_hba.conf" <<'EOF'

# CID
host     all            all             0.0.0.0/0               md5
EOF


sed -i -e "
/listen_addresses/i\
listen_addresses = '*'
" "${configdir}/postgresql.conf"

/etc/init.d/postgresql start
trap '/etc/init.d/postgresql stop' EXIT

postgresscript()
{
    sed -e "s|@@DATABASEDIR@@|${databasedir}|g" <<'SHELL'
initdb -D @@DATABASEDIR@@
psql -c "CREATE USER trac WITH PASSWORD 'trac';"
createdb -U postgres -O trac -E UTF8 trac
SHELL
}

su postgres -c "$(postgresscript)"
